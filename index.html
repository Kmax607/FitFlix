<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FitFlix Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f7f7f7;
        }
        #controls { margin: 15px; }
        #counterSection { margin-top: 15px; font-size: 1.5em; }
        video, canvas { border-radius: 12px; }
        .hidden { display: none; }

        /* Success popup */
        #popup {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
        }
        #popupContent {
            background: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
<h1>FitFlix Demo</h1>

<div id="controls">
    <label>Exercise:
        <select id="exerciseSelector">
            <option value="JumpingJack">Jumping Jacks</option>
            <option value="Pushup">Pushups</option>
            <option value="Squat">Squats</option>
            <option value="KneeHug">Knee Hug</option>
        </select>
    </label>

    <label>Goal:
        <input type="number" id="goalInput" min="1" value="10">
        <span id="goalUnit">reps</span>
    </label>

    <button onclick="init()">Start</button>
</div>

<div id="webcam-container"></div>
<div id="label-container" class="hidden"></div>
<div id="counterSection">
    <h2 id="counterText">Reps: <span id="counter">0</span></h2>
</div>

<div id="popup">
    <div id="popupContent">Goal complete! Nice work!</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script>
    const URL = "./my_model/";
    let model, webcam, labelContainer, maxPredictions;
    let counter = 0;
    let lastPosition = "";
    let goal = 10;
    let exercise = "JumpingJack";
    let counting = true;

    // For KneeHug
    let kneeSeconds = 0;
    let kneeSide = 1;
    let kneeStartTime = null;
    let kneePaused = false;

    const exerciseClasses = {
        JumpingJack: ["JackUp", "JackOut"],
        Pushup: ["PushUp", "PushDown"],
        Squat: ["SquatUp", "SquatDown"],
        KneeHug: ["KneeHug"]
    };

    document.getElementById("exerciseSelector").addEventListener("change", e => {
        exercise = e.target.value;
        document.getElementById("goalUnit").innerText = (exercise === "KneeHug") ? "seconds" : "reps";
    });

    async function init() {
        exercise = document.getElementById("exerciseSelector").value;
        goal = parseInt(document.getElementById("goalInput").value);
        counter = 0;
        counting = true;
        lastPosition = "";
        document.body.style.background = "#f7f7f7";

        document.getElementById("counterSection").classList.remove("hidden");
        document.getElementById("counterText").innerText =
            (exercise === "KneeHug") ? "Hold Time: 0s" : "Reps: 0";

        // Reset KneeHug state
        kneeSeconds = 0;
        kneeSide = 1;
        kneeStartTime = null;
        kneePaused = false;

        // Clean up old webcam feed if any
        if (webcam) {
            await webcam.stop();
            document.getElementById("webcam-container").innerHTML = "";
        }

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        webcam = new tmImage.Webcam(300, 300, true);
        await webcam.setup();
        await webcam.play();
        document.getElementById("webcam-container").appendChild(webcam.canvas);
        window.requestAnimationFrame(loop);

        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "";
        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        if (!counting) return;

        const prediction = await model.predict(webcam.canvas);
        let filtered = prediction.filter(p => exerciseClasses[exercise].includes(p.className));
        if (filtered.length === 0) return;

        let bestMatch = filtered.reduce((a, b) => (a.probability > b.probability ? a : b));
        if (bestMatch.probability < 0.8) return;

        if (exercise === "JumpingJack") {
            if (bestMatch.className === "JackUp" && lastPosition === "JackOut") incrementCounter();
            lastPosition = bestMatch.className;
        }
        if (exercise === "Pushup") {
            if (bestMatch.className === "PushUp" && lastPosition === "PushDown") incrementCounter();
            lastPosition = bestMatch.className;
        }
        if (exercise === "Squat") {
            if (bestMatch.className === "SquatUp" && lastPosition === "SquatDown") incrementCounter();
            lastPosition = bestMatch.className;
        }
        if (exercise === "KneeHug") handleKneeHug(bestMatch);
    }

    function incrementCounter() {
        counter++;
        document.getElementById("counterText").innerText = `Reps: ${counter}`;
        if (counter >= goal) completeExercise();
    }

    function handleKneeHug(bestMatch) {
        const now = Date.now();
        if (bestMatch.className === "KneeHug") {
            if (!kneeStartTime) kneeStartTime = now;
            else if (!kneePaused) {
                const elapsed = (now - kneeStartTime) / 1000;
                if (elapsed >= 1) {
                    kneeSeconds++;
                    kneeStartTime = now;
                    document.getElementById("counterText").innerText =
                        `Side ${kneeSide}: ${kneeSeconds}s`;
                }

                if (kneeSeconds >= 10 && kneeSide === 1) {
                    kneeSide = 2;
                    kneeSeconds = 0;
                    kneePaused = true;
                    document.getElementById("counterText").innerText = "Switch sides!";
                    setTimeout(() => { kneePaused = false; }, 2000);
                } else if (kneeSeconds >= 10 && kneeSide === 2) {
                    completeExercise();
                }
            }
        } else {
            kneeStartTime = null;
        }
    }

    function completeExercise() {
        counting = false;
        document.getElementById("counterSection").classList.add("hidden");
        document.body.style.background = "#d6ffd6";
        showPopup("Goal complete! Nice work!");
    }

    function showPopup(message) {
        const popup = document.getElementById("popup");
        document.getElementById("popupContent").innerText = message;
        popup.style.visibility = "visible";
        setTimeout(() => { popup.style.visibility = "hidden"; }, 3000);
    }
</script>
</body>
</html>
